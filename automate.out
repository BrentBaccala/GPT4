#!/usr/bin/env python3

import getpass
import sys
from time import sleep
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

email = "cosine@freesoft.org"

options = Options()
options.headless = False
driver = webdriver.Firefox(options=options)

driver.get("https://poe.com/")

WebDriverWait(driver, 10).until(EC.frame_to_be_available_and_switch_to_it((By.XPATH, '//iframe[@title="Sign in with Google Dialog"]')))
WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "continue"))).click()

WebDriverWait(driver, 10).until(EC.number_of_windows_to_be(2))
signin_window = [window for window in driver.window_handles if window != driver.current_window_handle][0]
driver.switch_to.window(signin_window)

WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CSS_SELECTOR, 'input[type="email"]'))).send_keys(email)
driver.find_element(By.CSS_SELECTOR, 'input[type="email"]').send_keys(Keys.RETURN)

password = getpass.getpass(prompt="Enter password: ", stream=sys.stderr)
driver.find_element(By.CSS_SELECTOR, 'input[type="password"]').send_keys(password)
driver.find_element(By.CSS_SELECTOR, 'input[type="password"]').send_keys(Keys.RETURN)

WebDriverWait(driver, 10).until(EC.number_of_windows_to_be(1))
driver.switch_to.window(driver.window_handles[0])

try:
    WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, '//p[text()="Claude+"]'))).click()
except:
    print("Bad password")
    driver.quit()
    sys.exit(1)

send_button_xpath = '//textarea[@placeholder="Talk to Claude+ on Poe"]/parent::div/parent::div/button'
WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, send_button_xpath)))

entry_box = driver.find_element(By.XPATH, '//textarea[@placeholder="Talk to Claude+ on Poe"]')
entry_box.send_keys("count from 1 to 10")
driver.find_element(By.XPATH, send_button_xpath).click()

WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, send_button_xpath)))

copy_button = driver.find_elements(By.XPATH, '//button[contains(text(), "Copy") and .//svg]')[-1]
driver.execute_script("arguments[0].click();", copy_button)

clipboard_text = driver.execute_script("return navigator.clipboard.readText();")
print(clipboard_text)

try:
    while True:
        sleep(1)
except KeyboardInterrupt:
    pass

driver.quit()
