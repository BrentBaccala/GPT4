#!/usr/bin/env python3

import getpass
import time
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.common.action_chains import ActionChains

options = Options()
options.headless = False

driver = webdriver.Firefox(options=options)
driver.get("https://poe.com/")

# Find the iframe containing the "Continue" button
wait = WebDriverWait(driver, 10)
iframe = wait.until(EC.frame_to_be_available_and_switch_to_it((By.XPATH, '//iframe[@title="Sign in with Google Dialog"]')))

# Click the "Continue" button
continue_button = wait.until(EC.element_to_be_clickable((By.ID, "continue")))
continue_button.click()

# Switch to the "Sign in - Google Accounts" window
wait.until(EC.number_of_windows_to_be(2))
signin_window = [window for window in driver.window_handles if window != driver.current_window_handle][0]
driver.switch_to.window(signin_window)

# Enter the email address and click "Next"
email_input = driver.find_element(By.XPATH, '//input[@type="email"]')
email_input.send_keys("cosine@freesoft.org")
email_input.send_keys(Keys.RETURN)

# Prompt the user for the password without echoing it
password = getpass.getpass("Enter your password: ")

# Enter the password and click "Next"
password_input = driver.find_element(By.XPATH, '//input[@type="password" and @name="Passwd"]')
password_input.send_keys(password)
password_input.send_keys(Keys.RETURN)

# Check if the sign in window disappeared
wait.until(EC.number_of_windows_to_be(1))

# Switch back to the original window
driver.switch_to.window(driver.window_handles[0])

# Wait for the name of the chatbot to appear and click on it
chatbot = wait.until(EC.element_to_be_clickable((By.XPATH, '//p[contains(text(), "ChatGPT")]')))
chatbot.click()

# Find the entry box and enter the user query
entry_box = wait.until(EC.presence_of_element_located((By.XPATH, '//textarea[contains(@placeholder, "Talk to ChatGPT on Poe")]')))
entry_box.send_keys("write a Python program that counts from 1 to 10")

# Find the send button and click it
send_button = driver.find_element(By.XPATH, '//textarea[contains(@placeholder, "Talk to ChatGPT on Poe")]/parent::div/parent::div/button')
send_button.click()

# Wait for five seconds
time.sleep(5)

# Find the copy button and click it
copy_button = driver.find_element(By.XPATH, '//button[contains(.//text(), "Copy") and .//svg]')
ActionChains(driver).click(copy_button).perform()

# Print copied text to stdout
clipboard_text = driver.execute_script("return navigator.clipboard.readText();")
print(clipboard_text)

# Pause indefinitely until the user hits Ctrl-C
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    pass
finally:
    driver.quit()
